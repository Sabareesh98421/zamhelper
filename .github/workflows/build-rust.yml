name: Build Rust for Linux

on:
  push:
    paths:
      - 'app/lib/parser/rust-ocr/**'
      - '.github/workflows/build-rust.yml'

jobs:
  build-linux-binary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y tesseract-ocr libtesseract-dev libleptonica-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Build Rust Binary (Release)
        working-directory: app/lib/parser/rust-ocr
        run: cargo build --release

      - name: Commit Linux Binary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Move binary to a known location
          mkdir -p app/lib/parser/bin/linux
          cp app/lib/parser/rust-ocr/target/release/rust-ocr app/lib/parser/bin/linux/rust-ocr
          
          git add app/lib/parser/bin/linux/rust-ocr
          git commit -m "chore: update linux rust binary [skip ci]" || echo "No changes to commit"
          git push
